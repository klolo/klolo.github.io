
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Zaimplementuj dependency injection w Typescript - Łódzki programista</title>
  <meta name="author" content="Kamil Lolo">

  
  <meta name="description" content="Typescript jest nadzbiorem javascriptu oferującym statyczne typowanie oraz możliwość programowania obiektowego w dużo bardziej wygodnej formie niż &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://klolo.github.io/blog/2017/09/03/zaimplementuj-dependency-injection-w-typescript">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="" rel="alternate" title="Łódzki programista" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-104079933-1', 'auto');
    ga('send', 'pageview');
</script>

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header style="text-align: center" role="banner"><img src="/images/logo.png" />
</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script>
  <script type='text/javascript'>kofiwidget2.init('Buy me a coffee', '#25baf1', 'A187461B');kofiwidget2.draw();</script>
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Programowanie</a></li>
  <li><a href="/lodz">Łódź</a></li>
  <li><a href="/blog/archives">Archiwum</a></li>
  <li><a href="/about">O mnie</a></li>
</ul>
</nav>
  <div id="main">
    <div id="content">
      <progress value="0" id="progressBar">
  <div class="progress-container">
    <span class="progress-bar"></span>
  </div>
</progress>

<div>
<article class="hentry" role="article">
  
  <header>
  
    
      <h1 class="entry-title">Zaimplementuj dependency injection w Typescript</h1>
    
  
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-09-03T15:39:30+02:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2017</span></span> <span class='time'>3:39 pm</span></time>
        
        
      </p>
    
  </header>


<div class="entry-content"><p>Typescript jest nadzbiorem javascriptu oferującym statyczne typowanie oraz możliwość programowania obiektowego w dużo bardziej wygodnej formie niż prototypy
dostępne w ES5. Dzięki wykorzystaniu dekoratorów język ten miejscami przypomina bardzo Javę, w której możemy używać adnotacji. Patrząc jednak na wygenerowany
przez kompilator kod, podobieństwa do Javy już nie znajdziemy. Znajdziemy za to zwykły Javascript wykorzystujący prototypy. Pokażę dziś jak zaimplementować mechanizm,
który będzie pozwalał na wstrzykiwanie zależności w podobny do Springa sposób. Będzie to znakomita okazja, żeby poznać praktyczne zastosowanie dekoratorów Typescriptu.</p>

<!--more-->


<h2>Czym są dekoratory?</h2>

<p>Zacznijmy od wyjaśnienia, czym tak w ogóle w Ts jest dekorator. Jest to mechanizm bardzo podobny do wzorca &ldquo;Dekorator&rdquo; znanego z programowania obiektowego. Dekorator jest funkcją, która na wejściu dostaje
inną funkcję/właściwość i dekoruje ją dodatkową logiką. Jak to wygląda w praktyce? Zobaczmy to na przykładzie dekoratora o nazwie Deprecated, którego zadaniem będzie wypisywanie
na ekranie informacji o tym, że wywołano właśnie przestarzałą metodę. Stwórzmy klasę, w której znajdzie się taki dekorator:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kr">class</span> <span class="nx">User</span> <span class="p">{</span>
    <span class="kr">public</span> <span class="nx">userName</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>

    <span class="nx">constructor</span><span class="p">(</span><span class="nx">userName</span><span class="o">?:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">userName</span> <span class="o">=</span> <span class="nx">userName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="err">@</span><span class="nx">Deprecated</span>
    <span class="nx">setUserName</span><span class="p">(</span><span class="nx">userName</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">userName</span> <span class="o">=</span> <span class="nx">userName</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>


<p>Klasa bardzo prosta. Zawiera konstruktor i setter. Z jakiś powodów setter został oznaczony dekoratorem Deprecated. Użycie dekoratora przypomina tutaj do złudzenia użycie adnotacji
w Java, mimo że mechanizm bardzo się od niej różni. Adnotacje w Javie służą do oznaczania pól czy metod, nie modyfikują jednak działania tych elementów, są tylko informacją
dla logiki umieszczonej w innym miejscu o tym, że należy wykonać jakąś dodatkową operację na adnotowanym polu/metodzie. W Ts dekoratory bezpośrednio modyfikują elementy klasy, nad którymi zostały
umieszczone. Dekoratorów użytych do oznaczenia metody w klasie może byc więcej. Nie musimy ograniczać się nawet do samych metod, możemy oznaczać w ten sposób również pola, parametry metod, a nawet całe klasy.
W końcu klasa w wygenerowanym przez kompilator Ts kodzie to również funkcja. Dla klasy <em>User</em> wygenerowany kod będzie miał taką postać:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">User</span><span class="p">(</span><span class="nx">userName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">userName</span> <span class="o">=</span> <span class="nx">userName</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setUserName</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">userName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">userName</span> <span class="o">=</span> <span class="nx">userName</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nx">__decorate</span><span class="p">([</span>
        <span class="nx">Deprecated</span><span class="p">,</span>
        <span class="nx">__metadata</span><span class="p">(</span><span class="s2">&quot;design:type&quot;</span><span class="p">,</span> <span class="nb">Function</span><span class="p">),</span>
        <span class="nx">__metadata</span><span class="p">(</span><span class="s2">&quot;design:paramtypes&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">String</span><span class="p">]),</span>
        <span class="nx">__metadata</span><span class="p">(</span><span class="s2">&quot;design:returntype&quot;</span><span class="p">,</span> <span class="k">void</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">],</span> <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s2">&quot;setUserName&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">User</span><span class="p">;</span>
<span class="p">}());</span>
<span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
<span class="kd">function</span> <span class="nx">Deprecated</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">descriptor</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">value</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">args</span><span class="p">[</span><span class="nx">_i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Using deprecated API: &quot;</span> <span class="o">+</span> <span class="nx">target</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">descriptor</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span></code></pre></div>


<p>Brrr&hellip;To, co wygenerowało się z tak prostej klasy wygląda na pierwszy rzut oka na bardzo skomplikowany kod. Jest to dobry przykład na to, jak wiele daje kompilator Ts.
Nie musimy pisać tak zawiłych konstrukcji, tylko tworzymy klasy w sposób do jakiego przywykliśmy w językach takich jak np. Java, C#. Wracając do przykładu z Deprecated, mamy klasę z metodą oznaczoną dekoratorem.
Dekorator to tak naprawdę funkcja, która ma na celu rozszerzenie działania innej funkcji. W tym przypadku funkcja taka przyjmuje 3 parametry:</p>

<ul>
<li>target - funkcja w której został użyty dekorator. W powyższym przykładzie będzie to funkcja reprezentująca klasę <em>User</em></li>
<li>key - nazwa metody, którą oznaczyliśmy adnotacją (<em>setUserName</em>)</li>
<li>descriptor - wynik wywołania funkcji <em>Object.getOwnPropertyDescriptor()</em> zwracający podstawowe informacje o polu które zostało oznaczone dekoratorem.
Przykładowo: <em>{&ldquo;writable&rdquo;:true,&ldquo;enumerable&rdquo;:true,&ldquo;configurable&rdquo;:true}</em></li>
</ul>


<p>Mając te wszystkie informacje możemy napisać dekorator, który będzie informował o użyciu przestarzałej metody:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">Deprecated</span><span class="p">(</span><span class="nx">target</span><span class="o">:</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">key</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">descriptor</span><span class="o">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">value</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(...</span><span class="nx">args</span><span class="o">:</span> <span class="nx">any</span><span class="p">[])</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="err">`</span><span class="nx">Using</span> <span class="nx">deprecated</span> <span class="nx">API</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">target</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">}.</span><span class="nx">$</span><span class="p">{</span><span class="nx">key</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">descriptor</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span></code></pre></div>


<p>Wartość zwrócona z dekoratora zastąpi deskryptor metody <em>setUserName</em>, a dokładnie pole <em>value</em> w tym deskryptorze. Krótko mówiąc nadpiszemy funkcję własną implementacją.
Dekorator po wylogowaniu na konsoli odpowiedniego ostrzeżenia wywołuje pierwotną metodę korzystając z <em>apply</em>, parametrów wywołania i zmiennej this. Jak widać logikę metody, nad którą
został wstawiony dekorator możemy dowolnie modyfikować, dekorować o kolejną logikę. Daje nam to potężny mechanizm do zmniejszenia ilości powielanego kodu i otwiera drogę do budowania
bardziej abstrakcyjnych mechanizmów.</p>

<h2>Wymagania</h2>

<p>Przedstawiona za chwilę implementacja Typescriptowej wersji Springa będzie wyjątkowo prosta. Będzie się ona składać z dekoratora @Bean, który to pozwoli automatycznie tworzyć obiekty klas i wstrzykiwać
je w pola, które będą miały dekorator @Inject. Przeanalizujmy zatem prosty przypadek użycia takiego narzędzia. Tworzymy klasę <em>User</em>, która będzie odpowiadać za przechowywanie
danych zalogowanego użytkownika. Dla uproszczenia będzie to tylko login:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="err">@</span><span class="nx">Bean</span><span class="p">()</span>
<span class="kr">class</span> <span class="nx">User</span> <span class="p">{</span>
    <span class="kr">public</span> <span class="nx">login</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>


<p>Kolejną klasą będzie <em>Transfer</em> odpowiedzialny za wykonanie przelewu dla zalogowanego użytkownika. Obiekt użytkownika będzie wstrzykiwany przez dekorator <em>Inject</em>, bez konieczności
ręcznego ustawiania pola. Dodatkowo pole w klasie będzie miało ustawiony modyfikator dostępu private, tak żeby nikomu nie przyszło do głowy próbować go ustawiać ręcznie.
Obiekt ten będzie singletonem przechowywanym przez omawianą implementację Springa.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="err">@</span><span class="nx">Bean</span><span class="p">()</span>
<span class="kr">class</span> <span class="nx">Transfer</span> <span class="p">{</span>
    <span class="err">@</span><span class="nx">Inject</span>
    <span class="kr">private</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">User</span><span class="p">;</span>

    <span class="nx">makeTransfer</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Create transfer for: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">login</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>


<p>Ostatnią klasą będzie <em>Application</em>, mająca wstrzykniętą instancję obiektu <em>User</em> oraz <em>Transfer</em>.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kr">class</span> <span class="nx">Application</span> <span class="p">{</span>

    <span class="err">@</span><span class="nx">Inject</span>
    <span class="kr">private</span> <span class="nx">transfer</span><span class="o">:</span> <span class="nx">Transfer</span><span class="p">;</span>

    <span class="err">@</span><span class="nx">Inject</span>
    <span class="kr">private</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">User</span><span class="p">;</span>

    <span class="nx">login</span><span class="p">(</span><span class="nx">userName</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="nx">userName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">sendTransfer</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">transfer</span><span class="p">.</span><span class="nx">makeTransfer</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">app</span><span class="o">:</span> <span class="nx">Application</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Application</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="s1">&#39;Kamil&#39;</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">sendTransfer</span><span class="p">();</span></code></pre></div>


<p>Podczas wywołania metody <em>login</em>, imię aktualnie zalogowanego użytkownika przekazywane jest do obiektu klasy <em>User</em>. Tak się składa, że ten sam obiekt został wstrzyknięty również do obiektu Transfer.
Omawiany mechanizm tworzy tylko jedną instancję obiektu i wszędzie ją wstrzykuje. Po wywołaniu metody <em>makeTransfer</em>, obiekt <em>Transfer</em>
prawidłowo wypisuje komunikat: <em>Create transfer for: Kamil</em>. Tak więc, bez konieczności martwienia się o utworzenie i ustawienie obiektu <em>User</em> i <em>Transfer</em> mamy możliwość korzystania z tych obiektów
w dowolnym miejscu aplikacji.</p>

<h2>Implementacja</h2>

<p>Przejdźmy teraz do właściwiej części, czyli do omówienia jak to działa. Pierwszym elementem jest moduł, za pomocą którego są przechowywane utworzone/wstrzykiwane obiekty. Dlaczego moduł?
Żeby np. nie brudzić przestrzeni nazw, mieć możliwość importu go w dowolnym miejscu aplikacji. Oto jak może wyglądać taki moduł:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">module</span> <span class="nx">ApplicationContext</span> <span class="p">{</span>
    <span class="kr">interface</span> <span class="nx">IRegister</span> <span class="p">{</span>
        <span class="p">[</span><span class="nx">key</span><span class="o">:</span> <span class="nx">string</span><span class="p">]</span><span class="o">:</span> <span class="nx">any</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">beanRegistry</span><span class="o">:</span> <span class="nx">IRegister</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="kr">export</span> <span class="kd">function</span> <span class="nx">registerBean</span><span class="p">(</span><span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nb">Object</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">beanRegistry</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
            <span class="kr">const</span> <span class="nx">lowerCaseName</span><span class="o">:</span> <span class="nx">string</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Register</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">lowerCaseName</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
            <span class="nx">beanRegistry</span><span class="p">[</span><span class="nx">lowerCaseName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kr">export</span> <span class="kd">function</span> <span class="nx">getBean</span><span class="p">(</span><span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">any</span> <span class="o">=</span> <span class="nx">beanRegistry</span><span class="p">[</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="err">`</span><span class="nx">Bean</span> <span class="nx">$</span><span class="p">{</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()}</span> <span class="nx">not</span> <span class="nx">found</span><span class="err">`</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>


<p>Moduł składa się z tablicy przechowującej utworzone obiekty. Tablica ta została zadeklarowana za pomocą interfejsu w celu umożliwienia odwoływania sie do elementów tablicy
poprzez klucz-string. Bez tego interfejsu moglibyśmy wyciągać obiekty tylko poprzez indeks. Moduł oprócz tablicy zawiera funkcję, która zapisuje nowe obiekty w tablicy pod przekazaną nazwą.
Nazwa jest zamieniana na małe litery, podobnie jak w dalszej części kodu. Jest to rozwiązanie bardzo proste, jednak posiada tą wadę, że w przypadku gdy pole oznaczone <em>Inject</em> będzie się nazywać
inaczej niż nazwa klasy pisana małymi literami, to mechanizm nie znajdzie obiektu. W przypadku gdy obiekt istnieje już w tablicy nic nie zostanie zrobione. Warto tutaj się pokusić o wyrzucenie
błędu z informacją: <em>multiple bean definition found</em>. Druga metoda modułu wyciąga z tablicy utworzony obiekt i go zwraca. W przypadku braku obiektu wyrzucany jest błąd.</p>

<p>Zajmijmy się teraz dekoratorem odpowiedzialnym za rejestrowanie komponentów w <em>beanRegistry</em>:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">Bean</span><span class="p">()</span><span class="o">:</span> <span class="nx">any</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">target</span><span class="o">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span>

        <span class="kd">function</span> <span class="nx">construct</span><span class="p">(</span><span class="nx">constructor</span><span class="o">:</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">args</span><span class="o">:</span> <span class="nx">any</span><span class="p">,</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">c</span><span class="o">:</span> <span class="nx">any</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">c</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="kd">let</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">any</span> <span class="o">=</span> <span class="nx">construct</span><span class="p">(</span><span class="nx">original</span><span class="p">,</span> <span class="p">[]);</span>
        <span class="nx">ApplicationContext</span><span class="p">.</span><span class="nx">registerBean</span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>

        <span class="kd">let</span> <span class="nx">f</span><span class="o">:</span> <span class="nx">any</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(...</span><span class="nx">args</span><span class="o">:</span> <span class="nx">any</span><span class="p">[])</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;create:&#39;</span> <span class="o">+</span> <span class="nx">target</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">());</span>
            <span class="kd">let</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">any</span> <span class="o">=</span> <span class="nx">construct</span><span class="p">(</span><span class="nx">original</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">f</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">original</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">f</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>


<p>Dekorator <em>Bean</em> tworzy funkcję <em>f</em>, która zastępuje konstruktor klasy oznaczonej tym dekoratorem. Funkcja ta odpowiada za wywołanie oryginalnego konstruktora, zapisanie utworzonego
obiektu w tablicy <em>beanRegistry</em> za pomocą funkcji <em>registerBean</em> oraz zwrócenie instancji obiektu obiektu. Mamy mechanizm rejestrowania komponentów, spójrzmy teraz jak działa
wstrzykiwanie tych komponentów:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">Inject</span><span class="p">(</span><span class="nx">target</span><span class="o">:</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">key</span><span class="o">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">_val</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>

    <span class="kr">const</span> <span class="nx">getter</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_val</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;create:&#39;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">());</span>
            <span class="nx">_val</span> <span class="o">=</span> <span class="nx">ApplicationContext</span><span class="p">.</span><span class="nx">getBean</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
            <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_val</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Get</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">key</span><span class="p">}</span> <span class="o">=&gt;</span> <span class="nx">$</span><span class="p">{</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">_val</span><span class="p">)}</span><span class="err">`</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">_val</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">delete</span> <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">get</span><span class="o">:</span> <span class="nx">getter</span><span class="p">,</span>
            <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">configurable</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>


<p>Główną rzeczą jaką robi ten dekorator jest nadpisywanie gettera dla właściwości, z którą został użyty. Podczas odwoływania się do takiego pola, zostaje uruchomiony zdefiniowany tutaj
getter. Zwraca on instancję obiektu o nazwie takiej, jak nazwa pola gdzie został użyty <em>Inject</em>. Nazwa ta musi oczywiście odpowiadać nazwie klasy, którą chcemy wstrzyknąć. Ot, to cała magia kryjąca się
za wstrzykiwaniem zależności.</p>

<h2>Quo vadis?</h2>

<p>Za pomocą dekoratorów stworzyliśmy bardzo prosty mechanizm DI. Nic nie stoi na przeszkodzie, żeby go rozbudować i korzystać z niego w np. aplikacjach serwerowych pisanych w Node.js. Jak to mówią,
<em>sky is the limit</em>.
Jednak żeby stworzone tutaj rozwiązanie było w pełni wartościowe, należy zatroszczyć się o kilka rzeczy:</p>

<ul>
<li>możliwość definiowania sposobu tworzenia komponentów. Obecnie zawsze jest to singleton i nie ma możliwości tworzenia kolejnych obiektów za pomocą tego mechanizmu</li>
<li>usuwanie obiektów z rejestru, kiedy zostaje usunięty ostatni obiekt korzystający z komponentu. Pozwoli to uniknąć wycieków pamięci. Może warto dodać jakiś licznik w rejestrze?</li>
<li>definiowanie dowolnej nazwy komponentu, w tej formie zawsze nazwa pola musi pokrywać się z nazwą klasy</li>
<li>w przypadku obsługi wielu użytkowników w aplikacji, rejestr powinien być związany z sesją użytkownika.</li>
</ul>


<p>Zachęcam do samodzielnej próby rozbudowy tego mechanizmu, kto wie, może to Twoja implementacja będzie w przyszłości popularnym DI dla Node.js ;)</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Kamil Lolo</span></span>

      




<time class='entry-date' datetime='2017-09-03T15:39:30+02:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2017</span></span> <span class='time'>3:39 pm</span></time>
    </p>
    <p class="meta">
      Kategoria: 

<span class="categories">
  
    <a class='category' href='/blog/categories/typescript/'>typescript</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://klolo.github.io/blog/2017/09/03/zaimplementuj-dependency-injection-w-typescript/" data-via="" data-counturl="http://klolo.github.io/blog/2017/09/03/zaimplementuj-dependency-injection-w-typescript/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/08/28/java-stream-api-darmowy-kurs/" title="Previous Post: Java stream API - darmowy kurs">&laquo; Java stream API - darmowy kurs</a>
      
      
        <a class="basic-alignment right" href="/blog/2017/09/17/typescript-wprowadzenie-czesc-2/" title="Next Post: Typescript wprowadzenie - część 2">Typescript wprowadzenie - część 2 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2021/03/07/spring-boot-wystawianie-endpointow-na-wielu-portach/">[spring boot] Wystawianie endpointów na wielu portach</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/03/07/java-zwiezle-deklarowanie-beanow/">Java: zwięzłe deklarowanie beanów</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/02/18/dependency-injection-w-js/">Dependency injection w js</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/12/17/w-oczekiwaniu-na-jave-10/">W oczekiwaniu na Java 10</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/10/28/dlugie-metody-w-kodzie-udany-przepis-na-bledy/">Długie metody w kodzie – udany przepis na błędy</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/10/17/dlaczego-obiekty-niezmienne-w-projekcie-to-blogoslawienstwo-i-o-tym-jak-nie-pisac-testow/">Dlaczego obiekty niezmienne w projekcie to błogosławieństwo i o tym jak nie pisać testów</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/10/14/pierwsze-spotkanie-z-react/">Pierwsze spotkanie z React</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/09/17/typescript-wprowadzenie-czesc-2/">Typescript wprowadzenie - część 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/09/03/zaimplementuj-dependency-injection-w-typescript/">Zaimplementuj dependency injection w Typescript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/08/28/java-stream-api-darmowy-kurs/">Java stream API - darmowy kurs</a>
      </li>
    
  </ul>
</section>

<section>
  <h2>  
    <a href="https://github.com/klolo">@klolo</a> on GitHub
    
  </h2>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>

  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'klolo',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


<!-- Pasek postepu podczas czytania -->
<script>
    $(document).ready(function(){
        var getMax = function(){
            return $(document).height() - $(window).height();
        }

        var getValue = function(){
            return $(window).scrollTop();
        }

        if('max' in document.createElement('progress')){
            // Browser supports progress element
            var progressBar = $('progress');

            // Set the Max attr for the first time
            progressBar.attr({ max: getMax() });

            $(document).on('scroll', function(){
                // On scroll only Value attr needs to be calculated
                progressBar.attr({ value: getValue() });
            });

            $(window).resize(function(){
                // On resize, both Max/Value attr needs to be calculated
                progressBar.attr({ max: getMax(), value: getValue() });
            });
        }
        else {
            var progressBar = $('.progress-bar'),
                max = getMax(),
                value, width;

            var getWidth = function(){
                // Calculate width in percentage
                value = getValue();
                width = (value/max) * 100;
                width = width + '%';
                return width;
            }

            var setWidth = function(){
                progressBar.css({ width: getWidth() });
            }

            $(document).on('scroll', setWidth);
            $(window).on('resize', function(){
                // Need to reset the Max attr
                max = getMax();
                setWidth();
            });
        }
    });


    $(document).ready(function(){
        $('#flat').addClass("active");
        $('#progressBar').addClass('flat');

        $('#flat').on('click', function(){
            $('#progressBar').removeClass().addClass('flat');
            $('a').removeClass();
            $(this).addClass('active');
            $(this).preventDefault();
        });

        $('#single').on('click', function(){
            $('#progressBar').removeClass().addClass('single');
            $('a').removeClass();
            $(this).addClass('active');
            $(this).preventDefault();
        });

        $('#multiple').on('click', function(){
            $('#progressBar').removeClass().addClass('multiple');
            $('a').removeClass();
            $(this).addClass('active');
            $(this).preventDefault();
        });

        $('#semantic').on('click', function(){
            $('#progressBar').removeClass().addClass('semantic');
            $('a').removeClass();
            $(this).addClass('active');
            $(this).preventDefault();
            alert('hello');
        });
    });
</script>
    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - Kamil Lolo <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>, customized with <a href="https://github.com/mjhea0/whiterspace">whiterspace</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'klolo-github-io';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://klolo.github.io/blog/2017/09/03/zaimplementuj-dependency-injection-w-typescript/';
        var disqus_url = 'http://klolo.github.io/blog/2017/09/03/zaimplementuj-dependency-injection-w-typescript/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
